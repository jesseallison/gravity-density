<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>gravity | density hub</title>
  <!-- <meta name="viewport" content="width=device-width, initial-scale=1"> -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />


  <link rel="stylesheet" href="/styles/main.css">

  <link href="http://fonts.googleapis.com/css?family=Vollkorn" rel="stylesheet" type="text/css">

  <script src="/socket.io/socket.io.js"></script>
  <script type="text/javascript" src="/js/Tone.js"></script>
  <script type="text/javascript" src="/js/nexusUI.js"></script>
  <script type="text/javascript" src="/js/browserHub.js"></script>
  <script type="text/javascript" src="/js/StartAudioContext.js"></script>
  <script src="/js/wavesurfer.min.js"></script>
  <script src="/js/wavesurfer.regions.min.js"></script>

</head>

<body>
  <div class="display">

    <h1"><span class="mainTitle">Gravity | Density</span></h1>

      <div class="nexusOverlay">
        <p>Example | <strong>Testing</strong></p>
        <p>Start by tapping your approximate location in the space.</p>
        <svg version="1.1" id="seatMap" x="0px" y="0px" viewbox="0 0 640 445"
          style="max-width: 70vh; enable-background:new 0 0 640 445;">
          <rect x="4" y="4" style="fill:none;stroke:#B3B3B3;stroke-width:8;stroke-miterlimit:10;" width="632"
            height="437" />
          <rect x="77.5" y="70" style="fill:none;stroke:#4D4D4D;stroke-width:8;stroke-miterlimit:10;" width="485.1"
            height="350" />
          <line style="fill:none;stroke:#4D4D4D;stroke-width:18;stroke-miterlimit:10;" x1="30" y1="40" x2="610"
            y2="40" />
        </svg>
      </div>

      <div class="mainDisplay">
        <p>
          <br>
          <br><em>Thanks for tapping!<br>
            Have more users connect.<br>
            Tap the title above to test your audio.</em>
          <br>
          <div id="slider"></div>
          <br>
          <div id="waveform"></div>
          <br><audio controls></audio>
          <div id="samples">
            <div id="player-1">
              <div id="record-1"></div>
              <div id="play-1"></div>
              <div id="loopBegin-1"></div>
              <div id="loopEnd-1"></div>
            </div>
          </div>

          <br><br>
          <button onClick="tapEnd()">Tap To End Session</button>
        </p>

      </div>

  </div>

  <div id="typed-text">...</div>

  <div class="endDisplay" style="display: none;">
    <p>
      <br>
      <br><em>Nice Set<br>
        Please visit <a href="http://gravity.emdm.io">gravity.emdm.io</a> for documentation.</em>
    </p>
  </div>

  <script>
    var Hub = require('hub');
    var hub = new Hub();
    hub.init();

    hub.user.name = "gravityHub";
    hub.user.color = getRandomColor();
    hub.user.location = {
      x: 0.5,
      y: 0.5
    }

    let playerSampleCount = 0;
    let sampleLength = 5000;

    // *** Nexus UI Elements ***

    let record_1 = new Nexus.Toggle("#record-1");
    let play_1 = new Nexus.Toggle("#play-1");
    let loopBegin_1 = new Nexus.Number("#loopBegin-1");
    let loopEnd_1 = new Nexus.Number("#loopEnd-1");

    record_1.on('change', function (v) {
      v ? gravSound.recorder.start() : gravSound.recorder.stop();
    });


    // Shared slider... possibly a good volume control?
    let slider = new Nexus.Slider('#slider', {
      'mode': 'absolute'
    });
    hub.channel('sharedSlider', null, null, function (data) {
      slider.value = data.value;
    });
    slider.on('change', function (v) {
      // do not send along if not changed from a user interaction.
      if (slider.clicked) {
        hub.send('sharedSlider', {
          value: v
        });
      };
    });

    // ****** Player Communications ****** //

    hub.channel('sampleSound', null, null, function (data) {
      let user = data.user;
      let sampleState = data.sampleState;

      if (sampleState === "start") {
        gravSound.createSample(user, sampleLength);
      } else if (sampleState == "stop") {
        console.log("Stop Sampling? ", user);
      }
    });

    function sampleSound(data) {
      hub.send('sampleSound', [data.user], data);
    }


    var secNum = 0;

    document.getElementsByTagName('body')[0].style.borderLeft = "15px solid" + hub.user.color;

    seatMap.addEventListener('click', getClickPosition, false);
    StartAudioContext(Tone.context, '#seatMap').then(function () {
      console.log("AudioStarted");
    })

    function getClickPosition(e) {
      var m = seatMap.getScreenCTM();
      var p = document.getElementById('seatMap').createSVGPoint();
      p.x = e.clientX;
      p.y = e.clientY;
      p = p.matrixTransform(m.inverse());
      var tx = document.getElementById('seatMap').getAttribute('viewBox').split("")[2];
      var ty = document.getElementById('seatMap').getAttribute('viewBox').split("")[3];
      var mx = p.x / tx;
      var my = p.y / ty;

      hub.user.location.x = mx;
      hub.user.location.y = my;
      console.log(hub.user.location);

      gravSound.triggerPitch();
      hub.register();
      // FIXME: move default overlay into Hub
      document.getElementsByClassName("nexusOverlay")[0].style.display = 'none';
      document.getElementsByClassName("mainDisplay")[0].style.display = 'block';
      wavesurfer.load('data/mbira_em.mp3');
    }

    hub.channel('setSection', null, null, function (data) {
      console.log(data);
      console.log("the section is now:" + data.title);

      secNum = data.sect;

    });

    hub.channel('tap', null, null, function (data) {
      hub.log(`tap received: $ { data }`);
    })

    function tapButton() {
      hub.send('tap', {
        'tap': 1
      });
    }

    hub.channel('itemback', null, 'about', function (data) {
      console.log("itemback:", data);
    });


    function tapEnd() {
      document.getElementsByClassName("mainDisplay")[0].style.display = 'none';
      document.getElementsByClassName("endDisplay")[0].style.display = 'block';
    }


    function getRandomColor() {
      var letters = '0123456789ABCDEF'.split('');
      var color = '#';
      for (var i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
      }
      return color;
    }


    var GravSound = function () {

      this.tone = new Tone();

      this.wavesurfers = [];
      this.audio = [];

      // Audio Input
      var liveFeed = new Tone.UserMedia();
      Tone.UserMedia.enumerateDevices().then(function (devices) {
        console.log(devices)
      })
      liveFeed.open().then(function () {
        //promise resolves when input is available
      });

      this.audio[0] = document.querySelector('audio');
      this.dest = this.tone.context.createMediaStreamDestination();
      this.recorder = new MediaRecorder(this.dest.stream);

      liveFeed.connect(this.dest);

      const chunks = [];

      this.recorder.ondataavailable = evt => chunks.push(evt.data);
      this.recorder.onstop = evt => {
        let soundBlob = new Blob(chunks, {
          type: 'audio/ogg; codecs=opus'
        });

        this.audio[this.recorder.userNumber].src = URL.createObjectURL(soundBlob);
        this.wavesurfers[this.recorder.userNumber].loadBlob(soundBlob);

        let formdata = new FormData(); //create a from to of data to upload to the server
        formdata.append('soundBlob', soundBlob,
          this.recorder.user + 'Sample.ogg'
        ); // append the sound blob and the name of the file. third argument will show up on the server as req.file.originalname

        // Now we can send the blob to a server...
        let serverUrl = '/upload'; //we've made a POST endpoint on the server at /upload
        //build a HTTP POST request
        let httpRequestOptions = {
          method: 'POST',
          body: formdata, // with our form data packaged above
          headers: new Headers({
            'enctype': 'multipart/form-data' // the enctype is important to work with multer on the server
          })
        };

        fetch(serverUrl, httpRequestOptions).then(res => {
          console.log(res)
        }).then(error => {
          console.log(error)
        });
        console.log('recording stopped');

        // let data = {
        //   "user": data.id
        // };
        //data.sample = URL.createObjectURL(blob);
        // this.sendSample(data)
      };


      this.createSample = function (user, sampleLength) {

        // var url = URL.createObjectURL(blob);
        let sampleDiv = document.getElementById("samples");
        let newDiv = document.createElement("div");
        newDiv.setAttribute("id", "sample-" + playerSampleCount);
        let au = document.createElement('audio');
        let ws = document.createElement('div');
        ws.setAttribute("id", "waveform-" + playerSampleCount);
        au.setAttribute("id", 'audio-' + playerSampleCount);
        au.controls = 'controls';
        newDiv.appendChild(ws);
        newDiv.appendChild(au);
        sampleDiv.appendChild(newDiv);
        
        this.audio[playerSampleCount] = document.getElementById("audio-" + playerSampleCount);
        this.wavesurfers[playerSampleCount] = WaveSurfer.create({
          container: '#waveform-' + playerSampleCount,
          waveColor: 'violet',
          progressColor: 'purple',
          plugins: [
            WaveSurfer.regions.create({
              // regions: [{
              //         id: 1,
              //         start: 1,
              //         end: 3,
              //         drag: true,
              //         color: 'hsla(400, 100%, 30%, 0.5)'
              //     }]
              // dragSelection: {
              //     slop: 5
              // }
            })
          ]
        });

        // var li = document.createElement('li');
        // var link = document.createElement('a');
        // //add controls to the <audio> element 
        // au.controls = true;
        // au.src = url;
        // //link the a element to the blob 
        // link.href = url;
        // link.download = new Date().toISOString() + '.wav';
        // link.innerHTML = link.download;
        // //add the new audio and a elements to the li element 
        // li.appendChild(au);
        // li.appendChild(link);
        // //add the li element to the ordered list 
        // recordingsList.appendChild(li);

        this.recorder.start();
          // Passing the current playerSampleCount in as this.recorder.userNumber so that it remains the correct number is multiple records happen.
        let recordingTimer = setTimeout(
          (user, userNumber) => { // setup a timeout for the recording, after the time below expires, do the tings inside the {}
            this.recorder.user = user;
            this.recorder.userNumber = userNumber;
            console.log(user);
            this.recorder.stop(); // stop recording
          }, sampleLength, user, playerSampleCount) //record for sample length (in ms)

        playerSampleCount += 1;
      }


      this.sendSample = function (data) {
        // let data = {user: name, blob: blob}

        sampleSound(data);
      }


      // Effects and Synths

      this.tremolo = new Tone.Tremolo({
        "frequency": 8,
        "type": "sine",
        "depth": 0.6,
        "spread": 0
        //"wet": 0.8
      }).toMaster().start();

      this.synth = new Tone.Synth({
        "oscillator": {
          "type": "sine"
        },
        "envelope": {
          "attack": 2.0,
          "decay": 0.5,
          "sustain": 0.8,
          "release": 2.0
        }
      }).connect(this.tremolo);

      this.synth.volume.value = -10;

      // Players

      this.player = [];
      this.player[0] = new Tone.Player("data/mp3s/CD_Track_2.mp3").toMaster();
      this.player[1] = new Tone.Player("data/mp3s/Collide.mp3").toMaster();

      Tone.Transport.start();

      this.pitchCollection = [55, 57, 59, 61, 62, 64, 66, 67, 68, 69, 71, 73, 75, 76, 78, 80, 82, 83];

      this.pitch = this.pitchCollection[Math.floor(Math.random() * (this.pitchCollection.length))];
      console.log("Pitch & Length:", this.pitch, this.pitchCollection.length);

      this.freq = function (midi) {
        var note = Tone.Frequency(midi).toFrequency();
        // console.log("Midi:", midi, note)
        return note;
      };

      // **** Playing Notes **** //
      this.playPitch = function (pitch) {
        if (pitch) {
          this.synth.triggerAttackRelease(this.freq(pitch), 0.5);
        } else {
          this.synth.triggerAttackRelease(this.freq(this.pitch), 5);

        }
      };

      this.playRandomPitch = function () {
        var pitch = this.pitchCollection[Math.floor(Math.random() * (this.pitchCollection.length))];
        this.synth.triggerAttackRelease(this.freq(pitch), 0.5);
      };

      this.triggerPitch = function () {
        this.synth.triggerAttackRelease(this.freq(this.pitch), 5);
        hub.send('triggerPitch', {
          'pitch': this.pitch
        });
      };

      this.playFirstSound = function () {
        this.player[0].start();
      };

      this.triggerFirstSound = function () {
        this.playPitch();
        this.player[0].start();
        // this.seqRandomize();
        hub.send('triggerFirstSound', {
          'pitch': this.pitch
        });

        var elements = document.getElementsByClassName("mainTitle");
        // elements[0].className +=" clicked";
        elements[0].style.backgroundColor = hub.user.color;
      };

      // ****  Events ****

      this.playSecondSound = function () {
        this.player[1].start();
        // var pitch = this.pitchCollection[Math.floor(Math.random() * (this.pitchCollection.length))];
        // this.synth.triggerAttackRelease(this.freq(pitch), 5);
        this.playRandomPitch();
      };

    };

    var gravSound = new GravSound();
    hub.user.pitch = gravSound.pitch;

    var wavesurfer = WaveSurfer.create({
      container: '#waveform',
      waveColor: 'violet',
      progressColor: 'purple',
      plugins: [
        WaveSurfer.regions.create({
          // regions: [{
          //         id: 1,
          //         start: 1,
          //         end: 3,
          //         drag: true,
          //         color: 'hsla(400, 100%, 30%, 0.5)'
          //     }]
          // dragSelection: {
          //     slop: 5
          // }
        })
      ]
    });

    // wavesurfer.enableDragSelection({
    //     id: 1,
    //     loop: true
    // });

    wavesurfer.on('ready', function () {
      // wavesurfer.play();
      wavesurfer.addRegion({
        id: 1,
        start: 1,
        end: 3,
        drag: true,
        loop: true,
        color: 'hsla(100, 100%, 30%, 0.5)'
      });
      wavesurfer.regions.list[1].on('update', function () {
        wavesurfer.regions.list[1].play();
        wavesurfer.regions.list[1].un('update');
      });
    });

    // Full Channel Declaration Standard transmit to 'others'
    // expected output: 
    hub.channel('test1', null, null, function (data) {
      console.log('test 1 received: ', data);
    })

    function test1() {
      console.log('test1 activated');
      hub.transmit('test1', null, {
        'test': '1'
      });
    }

    hub.channel('test2', null, ['display'], function (data) {
      console.log('test 2 received: ', data);
    })

    function test2() {
      hub.transmit('test2', null, {
        'test': 2
      });
    }

    // test3 overriding the channel declaration within the transmit function
    hub.channel('test3', null, ['controller'], function (data) {
      console.log('test 3 received: ', data);
    })

    function test3() {
      hub.transmit('test3', ['all'], {
        'test': 3
      });
    }

    // test4 overriding simplified channel declaration within the transmit function
    hub.channel('test4')

    function test4() {
      hub.transmit('test4', ['display'], {
        'test': 4
      });
    }

    // test5 no channel declaration just a transmit function
    function test5() {
      hub.transmit('test5', ['display'], {
        'test': 5
      });
    }

    // Just sending something.
    function test6() {
      hub.send('test6', 6);
    }
  </script>

</body>

</html>