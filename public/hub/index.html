<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>gravity | density hub</title>
  <!-- <meta name="viewport" content="width=device-width, initial-scale=1"> -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />


  <link rel="stylesheet" href="/styles/main.css">

  <!-- <link href="http://fonts.googleapis.com/css?family=Vollkorn" rel="stylesheet" type="text/css"> -->
  <link href="https://fonts.googleapis.com/css?family=Ubuntu&display=swap" rel="stylesheet">

  <script src="/socket.io/socket.io.js"></script>
  <script type="text/javascript" src="/js/Tone.js"></script>
  <script type="text/javascript" src="/js/nexusUI.js"></script>
  <script type="text/javascript" src="/js/GravSound.js"></script>
  <script type="text/javascript" src="/js/browserHub.js"></script>
  <script type="text/javascript" src="/js/StartAudioContext.js"></script>
  <script src="/js/wavesurfer.min.js"></script>
  <script src="/js/wavesurfer.regions.min.js"></script>

</head>

<body>
  <div class="display">
    <div id="header"><span class="title">Gravity|Density</span></div>

    <div class="nexusOverlay">
      <p>Example | <strong>Testing</strong></p>
      <p>Start by tapping your approximate location in the space.</p>
      <svg version="1.1" id="preMap" x="0px" y="0px" viewbox="0 0 640 445"
        style="max-width: 70vh; enable-background:new 0 0 640 445;">
        <rect x="4" y="4" style="fill:none;stroke:#B3B3B3;stroke-width:8;stroke-miterlimit:10;" width="632"
          height="437" />
        <rect x="77.5" y="70" style="fill:none;stroke:#4D4D4D;stroke-width:8;stroke-miterlimit:10;" width="485.1"
          height="350" />
        <line style="fill:none;stroke:#4D4D4D;stroke-width:18;stroke-miterlimit:10;" x1="30" y1="40" x2="610"
          y2="40" />
      </svg>
    </div>

    <div class="mainDisplay">
      <div id="map">
        <svg version="1.1" id="seatMap" x="0px" y="0px" viewbox="0 0 640 445"
          style="max-width: 70vh; enable-background:new 0 0 640 445;">
          <rect x="4" y="4" style="fill:none;stroke:#B3B3B3;stroke-width:8;stroke-miterlimit:10;" width="632"
            height="437" />
          <rect x="77.5" y="70" style="fill:none;stroke:#4D4D4D;stroke-width:8;stroke-miterlimit:10;" width="485.1"
            height="350" />
          <line style="fill:none;stroke:#4D4D4D;stroke-width:18;stroke-miterlimit:10;" x1="30" y1="40" x2="610"
            y2="40" />
        </svg>
      </div>
      <div class='controls'>
        <div id='sectionSelector'></div><div id='sectionNext'></div>
        <div id="slider"></div>
        <div id="loadLaunch"></div>Load Launch <div id="triggerLaunch"></div>Trigger Launch
        <div id="enableRecord"></div>Enable Record
        <div id="enableTouch"></div>Enable Touch
        <div id="enableLoop"></div>Enable Loop
      </div>
      <div id="samples">
        <!-- <div id="player-1">
          <div id="record-1"></div>
          <div id="play-1"></div>
          <div id="loopBegin-1"></div>
          <div id="loopEnd-1"></div>
        </div> -->
      </div>
      <br><br>
      <button onClick="tapEnd()">Tap To End Session</button>
    </div>

  </div>

  <div id="typed-text">...</div>

  <div class="endDisplay" style="display: none;">
    <p>
      <br>
      <br><em>Nice Set<br>
        Please visit <a href="http://gravity.emdm.io">gravity.emdm.io</a> for documentation.</em>
    </p>
  </div>

  <script>
    var Hub = require('hub');
    var hub = new Hub();

    hub.user.name ="gravityHub";
    hub.user.color = getRandomColor();
    hub.user.location = {
      x: 0.5,
      y: 0.5
    }

    hub.init();

    let sections = ['preConcert', 'spokenOpening', 'countdown', 'launch', 'space', 'gravity', 'postConcert'];
    let currentSection = 0;
    // let playerSampleCount = 0;
    // let sampleLength = 5000;

    let registeredUsers = [];

    // *** Nexus UI Elements ***

    let record = [];
    let play = [];
    let loopBegin = [];
    let loopEnd = [];
    let clear = [];

    let sectionNX = new Nexus.Select('#sectionSelector',{
      'size': [100,30],
      'options': sections
    });
    let sectionNextNX = new Nexus.Button('#sectionNext');
    
    let loadLaunchNX = new Nexus.Button("#loadLaunch");
    let triggerLaunch = new Nexus.Button("#triggerLaunch");
    let enableRecord = new Nexus.Toggle('#enableRecord');
    let enableTouch = new Nexus.Toggle('#enableTouch');
    let enableLoop = new Nexus.Toggle('#enableLoop');

    // let record_1 = new Nexus.Toggle("#record-1");
    // let play_1 = new Nexus.Toggle("#play-1");
    // let loopBegin_1 = new Nexus.Number("#loopBegin-1");
    // let loopEnd_1 = new Nexus.Number("#loopEnd-1");

    // record_1.on('change', function (v) {
    //   v ? gravSound.recorder.start() : gravSound.recorder.stop();
    // });

    enableRecord.on ('change', (v) => {
      let data = {};
      data.user ="all";
      data.val ="record";
      data.enabled = v;
      console.log(data)
      hub.transmit('enable', null, data);
    });

    enableTouch.on ('change', (v) => {
      let data = {};
      data.user ="all";
      data.val ="touch";
      data.enabled = v;
      console.log(data)
      hub.transmit('enable', null, data);
    });

    enableLoop.on ('change', (v) => {
      let data = {};
      data.user ="all";
      data.val ="loop";
      data.enabled = v;
      console.log(data)
      hub.transmit('enable', null, data);
    });


        // -------- LAUNCH CONTROLS
    loadLaunchNX.on('change', function (v) {
      if(v.state==false) {
        loadFile('/data/mp3s/AtlasVLaunch.mp3');
      }
    });

    triggerLaunch.on('change', function (v) {
      if(v.state==true) {
        let data = {
          user : 'all',
          val : 'play'
        }
        hub.transmit('sample',null, data);
      }
    });


    // Shared slider... possibly a good volume control?
    let slider = new Nexus.Slider('#slider', {
      'mode': 'absolute'
    });
    hub.channel('sharedSlider', null, null, function (data) {
      slider.value = data.val;
    });
    slider.on('change', function (v) {
      // do not send along if not changed from a user interaction.
      if (slider.clicked) {
        hub.send('sharedSlider', {
          val: v
        });
        // console.log(v);
        gravSound.gain.gain.setValueAtTime(v, gravSound.tone.context.currentTime, 0.015);
      };
    });

    // ****** Player Communications ****** //

    document.getElementsByTagName('body')[0].style.borderLeft = "15px solid" + hub.user.color;

    preMap.addEventListener('click', getClickPosition, false);
    StartAudioContext(Tone.context, '#preMap').then(function () {
      console.log("AudioStarted");
    })

    function getClickPosition(e) {
      var m = preMap.getScreenCTM();
      var p = document.getElementById('preMap').createSVGPoint();
      p.x = e.clientX;
      p.y = e.clientY;
      p = p.matrixTransform(m.inverse());
      var tx = document.getElementById('preMap').getAttribute('viewBox').split(" ")[2];
      var ty = document.getElementById('preMap').getAttribute('viewBox').split(" ")[3];
      var mx = p.x / tx;
      var my = p.y / ty;

      hub.user.location.x = mx;
      hub.user.location.y = my;
      console.log(hub.user.location);

      gravSound.triggerPitch();
      hub.register();
      // FIXME: move default overlay into Hub
      document.getElementsByClassName("nexusOverlay")[0].style.display = 'none';
      document.getElementsByClassName("mainDisplay")[0].style.display = 'block';
      // wavesurfer.load('data/mbira_em.mp3');
    }

    hub.channel('welcome', null, null, (data) => {
      console.log('welcome', data);
      registeredUsers.push[data]; 
      // {id: socket.id, username: socket.username, color: socket.userColor, location: socket.userLocation }
      let sv = document.getElementById('seatMap');
      let svgns = "http://www.w3.org/2000/svg";
      let circle = document.createElementNS(svgns, 'circle');

      // actual coordinates of the inner box
      // circle.setAttributeNS(null, 'cx', 77.5 + (data.location.x * 485.1));
      // circle.setAttributeNS(null, 'cy', 70 + (data.location.y * 350));
      circle.setAttributeNS(null, 'cx', (data.location.x * 640));
      circle.setAttributeNS(null, 'cy', (data.location.y * 445));
      circle.setAttributeNS(null, 'r', 5);
      circle.setAttributeNS(null, 'style', 'fill: orange; stroke: red; stroke-width: 1px;' );
      circle.setAttributeNS(null, 'id', data.username + "-seatmap");
      sv.appendChild(circle);
    });

      // ******* Sections *******
    hub.channel('setSection', null, null, function (data) {
      console.log(data);
      console.log("the section is now: " + sections[data.section]);

      currentSection = data.section;
      sectionNX.selectIndex = currentSection;
    });

    sectionNX.on ('change', (v) => {
      console.log('Section ', v.index, v.value, v);
      setSection(v.index);
    });

    sectionNextNX.on ('change', (v) => {
      if(v.state == true) {
        nextSection();
      }
    });

    function nextSection() {
      hub.send('section', {
        'section': 'next'
      });
    }

    function setSection(sect) {
      hub.send('section', {
        'section': sect
      });
    }

    hub.channel('tap', null, null, function (data) {
      hub.log(`tap received: $ { data }`);
    })

    function tapButton() {
      hub.send('tap', {
        'tap': 1
      });
    }

    hub.channel('itemback', null, 'about', function (data) {
      console.log("itemback: ", data);
    });


    function tapEnd() {
      document.getElementsByClassName("mainDisplay")[0].style.display = 'none';
      document.getElementsByClassName("endDisplay")[0].style.display = 'block';
    }


    function getRandomColor() {
      var letters = '0123456789ABCDEF'.split('');
      var color = '#';
      for (var i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
      }
      return color;
    }


    hub.channel('sample', null, null, (data) => {
      // data.user = "name", .val = "capture", .duration = "5"
      console.log("User? ", gravSound.userSamples[data.user]);

      if (gravSound.userSamples[data.user] == null) {
        if (data.val == "capture") {
          gravSound.createSample(data.user, gravSound.sampleLength);
        }
        console.log(`${data.user} recording a sample of ${gravSound.sampleLength} seconds`);
      }

      if (data.val == "loop") {
        gravSound.setLoop(data.user, data.loopBegin, data.loopEnd);
        if(data.play) {
          gravSound.playLoop(user);
        }
        console.log(`${data.user} set loop to ${data.loopBegin} – ${data.loopEnd}`);
      }

      if(data.user == "all") {
        // Probably shouldn't play if all is triggered.
      } else {
        if(data.val == "play") {
          gravSound.wavesurfers[gravSound.userSamples[data.user].id].regions.list[0].loop = false;
          gravSound.wavesurfers[gravSound.userSamples[data.user].id].regions.list[0].play();
        }
        if(data.val == "playLoop") {
          gravSound.wavesurfers[gravSound.userSamples[data.user].id].regions.list[0].loop = true;
          gravSound.wavesurfers[gravSound.userSamples[data.user].id].regions.list[0].playLoop();
        }
      }
    });

    function loadFile(file) {
      let data = {
        user : 'all',
        val : 'load',
        url : file
      }
      hub.transmit('sample', null, data);
    }

    hub.channel('loop', null, null, (data) => {
      // data.user = "name", .loopBegin = 0., .loopEnd = 1.0
      if (data.loopBegin >= 0.) {
        gravSound.wavesurfers[gravSound.userSamples[data.user].id].regions.list[0].start = data.loopBegin *
          gravSound.sampleLength;
      }
      if (data.loopEnd <= 1.0) {
        gravSound.wavesurfers[gravSound.userSamples[data.user].id].regions.list[0].end = data.loopEnd * gravSound
          .sampleLength;
      }

      console.log(`${data.user} set loop to ${data.loopBegin} – ${data.loopEnd}`);
    });

    var gravSound = new GravSound();
    hub.user.pitch = gravSound.pitch;

  </script>

</body>

</html>